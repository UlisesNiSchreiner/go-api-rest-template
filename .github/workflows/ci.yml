name: CI

on:
  pull_request:
  push:
    branches: ["master"]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Go test (with coverage)
        run: |
          go test \
            ./internal/services/... \
            ./internal/repositories/... \
            -coverprofile=coverage.out \
            -covermode=atomic

      - name: Enforce minimum coverage (80%)
        run: |
          total=$(go tool cover -func=coverage.out | awk '/total:/ {print substr($3, 1, length($3)-1)}')
          echo "Total coverage: ${total}%"
          awk -v cov="${total}" 'BEGIN { if (cov+0 < 80) { exit 1 } }'
          echo "Coverage gate passed"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      # ---- FORMAT CHECKS ----
      - name: gofmt check
        run: |
          test -z "$(gofmt -l .)"

      - name: goimports check
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          test -z "$(goimports -l .)"

      # ---- LINT ----
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.7.2
          args: --timeout=5m
